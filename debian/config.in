#include variables
#!/bin/sh -e
# 
# config maintainer script for the Debian <:=${PACKAGE}:> package.
# $Id: config.in 114 2005-08-04 15:04:01Z frn $
<:=@COPYRIGHT:>//

# Give names to the commandline arguments
action=$1
installed_version=$2

# common variables
FONTCACHE_PERMS=<:=$FONTCACHE_PERMS:>



. <:=${CONFMODULE}:>
db_version 2.0

<:open(FUNCTIONS,'common.functions');@FUNCTIONS=<FUNCTIONS>;close(FUNCTIONS):>//
<:=@FUNCTIONS:>//

## do the things we have to do for upgraders from old versions
# it does not harm to do the checks also when $action is reconfigure.

# suggest a user to rename old cnf files (copyright Atsuhito?)
# (upgrade from woody, keep for etch?)
if [ -d /etc/texmf/texmf.d ]; then
    if ls /etc/texmf/texmf.d 2> /dev/null | egrep -vq '(\.cnf|\.dpkg-.*|~)$'; then
	db_input medium tex-common/cnf_name || true
	db_go || true
    fi
fi


# we also unregister the tetex-bin/lsr-perms
db_unregister tetex-bin/lsr-perms || true

# and unregister old tex-common questions, they are not needed anymore
db_unregister tex-common/groupperm || true
db_unregister tex-common/userperm || true
db_unregister tex-common/managedlsr || true

# we set the groupname seen flag to false in any case since now it has
# a completely new meaning
db_fset tex-common/groupname seen false || true

# this script may be run twice: Once by dpkg-preconfigure, once again by
# debconf when it is sourced in the postinst script.  We must do the
# following only once, therefore we fiddle with a special flag
db_fget tex-common/managecache firstrundone || true

if [ "$RET" != "true" ]; then
  # we are in the first pass, set the flag and do the things
  db_fset tex-common/managecache firstrundone true

  # check wether the directory /var/cache/fonts is group writeable and
  # for which group
  PERMS=$(stat --format="%a" /var/cache/fonts 2>/dev/null)
  GROUP=$(stat --format="%G" /var/cache/fonts 2>/dev/null)

  if [ "$GROUP" = "UNKNOWN" ] ; then
    GROUP=$(stat --format="%g" /var/cache/fonts 2>/dev/null)
  fi

  # see wether we already have asked this question once
  db_fget tex-common/managecache seen || true
  SEEN="$RET"

  if [ $SEEN = true ] ; then
    # this question was already shown
    # if the permissions are still <:=$FONTCACHE_PERMS:> we set managecache to true
    if [ $PERMS = $FONTCACHE_PERMS ] ; then
      db_set tex-common/managecache true || true
      db_set tex-common/groupname "$GROUP" || true
    else
      db_set tex-common/managecache false || true
    fi
  else
    # this question has not been seen, so if the permissions are 
    # - either empty, because the file is not yet present
    # - or the new permissions <:=$FONTCACHE_PERMS:> as we want to ship them
    # - or the permissions as shipped by old tetex versions
    # then set the managecache to true, otherwise to false
    # we will later change it to <:=$FONTCACHE_PERMS:> in the true case
    #
    # If the permissions are as shipped in the deb, don't set to true
    # (after noninteractive install in pbuilder etc., dir needs to be world-writable).

    if [ -z "$PERMS" ] || [ "$PERMS" = $FONTCACHE_PERMS ] || [ "$PERMS" = 1777 ]; then
      db_set tex-common/managecache true || true
    else
      db_set tex-common/managecache false || true
    fi
  fi
  db_input medium tex-common/managecache || true
  db_go

  db_get tex-common/managecache || true
  if [ "$RET" = true ]; then
    db_input low tex-common/groupname || true
    db_go
  fi
fi

# Local Variables:
# mode: shell-script
# skeleton-pair: t
# End:

