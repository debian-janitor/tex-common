#include variables
#!/bin/sh -e
# 
# postinst maintainer script for the Debian <:=${PACKAGE}:> package.
# $Id$
<:=@COPYRIGHT:>//

## Define static variables we need
MKTMPDIR=<:=$MKTMPDIR:> # mktemp will create its files there
UCF_FILES="<:=$TEX_COMMON_UCF_FILES:>"
TEXMFSYSVAR="<:=$TEXMFSYSVAR:>"
UCF="ucf --debconf-ok"
#UCF="ucf -d --debconf-ok --verbose"
FIRST_VERSION_WITH_UPGRADE_PATH=0.3
OLD_LDAT=/etc/texmf/language.dat
POSTINST_MOVE_EXT="<:=$POSTINST_MOVE_EXT:>"

umask 022

# Give a name to the first commandline argument
action=$1

. <:=${CONFMODULE}:>
db_version 2.0

<:open(FUNCTIONS,'postinst.functions');@FUNCTIONS=<FUNCTIONS>;close(FUNCTIONS):>//
<:=@FUNCTIONS:>//

# <:open(FUNCTIONS,'common.functions');@FUNCTIONS=<FUNCTIONS>;close(FUNCTIONS):>//
# <:=@FUNCTIONS:>//

#################################################################
# Here starts the real action
#################################################################

case $action in
  configure|reconfigure)
    ## upgrade from 2.0.2 in sarge
    configured_version=$2
    # we must keep changes to the option part of 00updmap.cfg, if it is 
    # installed (from an older tetex-base package)
    dpkg --compare-versions \
      $FIRST_VERSION_WITH_UPGRADE_PATH gt "$configured_version" && \
      updmap_extract

# is there a file /etc/texmf/language.dat already? Move it out of the way
    if [ -f $OLD_LDAT ]; then
      cat > $OLD_LDAT.$POSTINST_MOVE_EXT <<EOF
This file is no longer used and has therefore been renamed by the postinst 
script of the tex-common package.

Please use the mechanism described in update-language(8) instead.

EOF
      cat $OLD_LDAT >> $OLD_LDAT.$POSTINST_MOVE_EXT 
      rm $OLD_LDAT
    fi


# normal install    
    # handle ucf-managed configuration files
    for file in $UCF_FILES; do
      $UCF /usr/share/tex-common/`basename $file` /etc/texmf/$file
    done

#
# create /usr/local/share/texmf, unless the filesystem is read-only:
#
    TEXMFLOCAL=/usr/local/share/texmf
    if [ ! -e $TEXMFLOCAL ]; then
      if mkdir $TEXMFLOCAL 2>/dev/null; then
        chmod 2775 $TEXMFLOCAL 2>/dev/null || true
	chown root:staff $TEXMFLOCAL 2>/dev/null || true
	ln -s /var/lib/texmf/ls-R-LOCAL /$TEXMFLOCAL/ls-R
      fi
    fi

#
# remove left over fmt/efmt/log files in /usr/share/texmf/web2c/
# move out of the way old config files
# 
    if [ -d /usr/share/texmf/web2c ] ; then
      rm -rf /usr/share/texmf/web2c/*.fmt
      rm -rf /usr/share/texmf/web2c/*.efmt
      rm -rf /usr/share/texmf/web2c/*.base
      rm -rf /usr/share/texmf/web2c/*.log
      for cfgfile in fmtutil.cnf updmap.cfg ; do
        oldname=/usr/share/texmf/web2c/$cfgfile
	newname=/usr/share/texmf/web2c/$cfgfile.pre-upgrade
        if [ -r $oldname ] ; then
	  cat - > $newname <<EOF
# This file conflicts with the new configuration location.
# Please merge your changes to the correct location.

EOF
	  cat $oldname >> $newname
	  rm $oldname
	fi
      done
    fi

# run our scripts - this way we ensure that the generated files are
# corrected, should one of the scripts have produced buggy output in 
# a prior version
    update-texmf
    update-fmtutil
    update-updmap
    update-language

#
# set permission of ls-R files
    db_get tex-common/managedlsr || true
    if [ -n "$RET" ] ; then
      MANAGEDLSR="$RET"
      echo "Fixing permissions and group of ($MANAGEDLSR) ls-R as specified by debconf ..."

      db_get tex-common/groupperm || true
      if [ x"$RET" = x"true" ]; then
        LSRPERMS=66
      else
        LSRPERMS=64
      fi
      db_get tex-common/userperm || true
      if [ x"$RET" = x"true" ]; then
        LSRPERMS="$LSRPERMS"6
      else
        LSRPERMS="$LSRPERMS"4
      fi
      db_get tex-common/groupname || true
      LSRGROUP="$RET"
      # fix permissions of all the ls-R files
      for lsr in main var local cache ; do
        case $lsr in 
	  main) LSR=$TEXMFSYSVAR/ls-R-TEXMFMAIN ;;
	  var)  LSR=$TEXMFSYSVAR/ls-R ;;
	  local) LSR=$TEXMFSYSVAR/ls-R-LOCAL ;;
	  cache) LSR=/var/cache/fonts/ls-R ;;
	  *) echo "This should not happen: Don't know how to set this! $lsr" ;;
	esac
	# special check wether the local ls-R is actually a link to var
	domanage=1
	if [ $lsr = local ] ; then
	  lsrlocalok=1
	  if [ -L /usr/local/share/texmf/ls-R ] ; then
	    linkdest=`readlink /usr/local/share/texmf/ls-R`
	    if [ ! "X$linkdest" = "X$LSR" ] ; then
	      lsrlocalok=0
	    fi
	  else
	    lsrlocalok=0
	  fi
	  # /usr/local/share/texmf/ls-R is either not a link or not the
	  # right link, ship out a message!
	  if [ $lsrlocalok = 0 ] ; then
	    # what do we do here?
	    # can we inform the user that something is wrong here?
	    domanage=0
	  fi
	fi
	if [ $domanage = 1 ] ; then
	  if echo "$MANAGEDLSR" | grep -q $lsr ; then
	    # this lsr is managed by debconf
	    chmod -v $LSRPERMS $LSR 2>/dev/null | fgrep changed || true
	    chgrp -v $LSRGROUP $LSR 2>/dev/null | fgrep changed || true
	  else
	    # this lsr has standard permissions
	    chmod -v 644 $LSR 2>/dev/null | fgrep changed || true
	    chown -v root:staff $LSR 2>/dev/null | fgrep changed || true
	  fi
	fi
      done
    fi
    ;;
  *)
    ;;
esac


#DEBHELPER#

# Local Variables:
# mode: shell-script
# End:
