#include variables
#!/bin/sh -e
# 
# postinst maintainer script for the Debian <:=${PACKAGE}:> package.
# $Id$
<:=@COPYRIGHT:>//

## Define static variables we need
MKTMPDIR=<:=$MKTMPDIR:> # mktemp will create its files there
UCF_FILES="<:=$TEX_COMMON_UCF_FILES:>"
TEXMFSYSVAR="<:=$TEXMFSYSVAR:>"
UCF="ucf --debconf-ok"
#UCF="ucf -d --debconf-ok --verbose"
OLD_LDAT=/etc/texmf/language.dat
POSTINST_MOVE_EXT="<:=$POSTINST_MOVE_EXT:>"
ls_R_magic='% ls-R -- filename database for kpathsea; do not change this line.
./:
.:
ls-R
'

umask 022

# Give a name to the first commandline argument
action=$1

. <:=${CONFMODULE}:>
db_version 2.0

<:open(FUNCTIONS,'postinst.functions');@FUNCTIONS=<FUNCTIONS>;close(FUNCTIONS):>//
<:=@FUNCTIONS:>//

# <:open(FUNCTIONS,'common.functions');@FUNCTIONS=<FUNCTIONS>;close(FUNCTIONS):>//
# <:=@FUNCTIONS:>//

#################################################################
# Here starts the real action
#################################################################

case $action in
  configure|reconfigure)

# is there a file /etc/texmf/language.dat already? Move it out of the way
    if [ -f $OLD_LDAT ]; then
      old_ldat_md5sum=`md5sum $OLD_LDAT`
      # do nothing if the md5sum matches sarge's or woody's default:
      if [ ! "$old_ldat_md5sum" = fe9baf0768ade79a585a9df568dac5f6 ] && \
	[ ! "$old_ldat_md5sum" = 1d2d9b25a41ab1cec892bd3382af7645 ]; then
	cat > $OLD_LDAT.$POSTINST_MOVE_EXT <<EOF
This file is no longer used and has therefore been renamed by the postinst 
script of the tetex-base package.

Please use the mechanism described in update-language(8) instead.

EOF
	cat $OLD_LDAT >> $OLD_LDAT.$POSTINST_MOVE_EXT 
      fi
      rm $OLD_LDAT
    fi


# normal install    
    # handle ucf-managed configuration files
    for file in $UCF_FILES; do
      $UCF /usr/share/tex-common/`basename $file` /etc/texmf/$file
    done

# remove left over fmt/efmt/log files in /usr/share/texmf/web2c/.  If they are
# there, it's because of an old bug or user misconfiguration, and they are
# never registered to dpkg.
#
# move out of the way old config files
# 
    if [ -d /usr/share/texmf/web2c ] ; then
      rm -rf /usr/share/texmf/web2c/*.fmt
      rm -rf /usr/share/texmf/web2c/*.efmt
      rm -rf /usr/share/texmf/web2c/*.base
      rm -rf /usr/share/texmf/web2c/*.log
      for cfgfile in fmtutil.cnf updmap.cfg ; do
        oldname=/usr/share/texmf/web2c/$cfgfile
	newname=/usr/share/texmf/web2c/$cfgfile.pre-upgrade
        if [ -r $oldname ] ; then
	  cat - > $newname <<EOF
# This file conflicts with the new configuration location.
# Please merge your changes to the correct location.

EOF
	  cat $oldname >> $newname
	  rm $oldname
	fi
      done
    fi

    update-texmf
# Now we check for some essential settings
    check_texmf /etc/texmf/texmf.d/55Fonts.cnf TEXFONTMAPS '.TEXMF/{fonts/,}map//;.TEXMF/dvips//'
    check_texmf /etc/texmf/texmf.cnf TEXFONTMAPS '.TEXMF/{fonts/,}map//;.TEXMF/dvips//'
    check_texmf /etc/texmf/texmf.d/05TeXMF.cnf TEXMFMAIN '/usr/share/texmf'
    check_texmf /etc/texmf/texmf.cnf TEXMFMAIN '/usr/share/texmf'
    check_texmf /etc/texmf/texmf.d/05TeXMF.cnf TEXMFDIST \
          '/usr/share/texmf-{tetex,texlive}|/usr/share/texmf-{texlive,tetex}'
    check_texmf /etc/texmf/texmf.cnf TEXMFDIST \
          '/usr/share/texmf-{tetex,texlive}|/usr/share/texmf-{texlive,tetex}'
    check_texmf /etc/texmf/texmf.d/05TeXMF.cnf 'TEXMF( |=)' TEXMFSYSCONFIG
    check_texmf /etc/texmf/texmf.cnf 'TEXMF( |=)' TEXMFSYSCONFIG
    check_texmf /etc/texmf/texmf.d/05TeXMF.cnf 'TEXMF( |=)' TEXMFSYSVAR
    check_texmf /etc/texmf/texmf.cnf 'TEXMF( |=)' TEXMFSYSVAR
    check_texmf /etc/texmf/texmf.d/05TeXMF.cnf 'TEXMF( |=)' TEXMFMAIN
    check_texmf /etc/texmf/texmf.cnf 'TEXMF( |=)' TEXMFMAIN
    check_texmf /etc/texmf/texmf.d/05TeXMF.cnf 'TEXMF( |=)' TEXMFDIST
    check_texmf /etc/texmf/texmf.cnf 'TEXMF( |=)' TEXMFDIST

# run our scripts - this way we ensure that the generated files are
# corrected, should one of the scripts have produced buggy output in 
# a prior version
    update-fmtutil
    update-updmap
    update-language

#
# set permission of ls-R files
    db_get tex-common/managedlsr || true
    falsegwritefiles=""
    truegwritefiles=""
    for i in var cache main ; do
      if echo $RET | grep -q $i ; then
	truegwritefiles="$truegwritefiles $i"
      else
	falsegwritefiles="$falsegwritefiles $i"
      fi
    done
    for i in $truegwritefiles ; do
      lsr=`select_lsrfile $i`
      test -e $lsr || echo "$ls_R_magic" > $lsr 
      chmod g+w $lsr
    done
    for i in $falsegwritefiles ; do
      lsr=`select_lsrfile $i`
      test -e $lsr || echo "$ls_R_magic" > $lsr 
      chmod g-w $lsr
    done
    db_get tex-common/groupname || true
    LSRGROUP="$RET"
    if [ -n "$LSRGROUP" ] ; then
      for i in $truegwritefiles ; do
	lsr=`select_lsrfile $i`
	chgrp -v $LSRGROUP $lsr || true
      done
    fi

# the config script may be run twice: Once by dpkg-preconfigure, once
# again by debconf when it is sourced in the postinst script.  On the
# first pass, it sets a special flag, which must now be reset.
    db_fset tex-common/managedlsr firstpass false || true

    ;;
  *)
    ;;
esac


#DEBHELPER#

# Local Variables:
# mode: shell-script
# End:
