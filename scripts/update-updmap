#! /bin/sh
#
# update-updmap --- Generate updmap.cfg from a set of files
# Copyright (C) 2002 Atsuhito Kohda
# Copyright (C) 2004 Florent Rougon
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 dated June, 1991.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; see the file COPYING. If not, write to the
# Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,
# MA 02111-1307, USA.

version="0.5"
progname=$(basename "$0")

CNFDIR=/etc/texmf/updmap.d
# There lies the information of whether a given font package is installed.
FONTMAP_MEMORY_DIR=/var/lib/tetex/debian/fontmap-cfg

VARD=/var/lib/texmf/web2c
CFGFILE_BASENAME=updmap.cfg
CFGFILE="$VARD/$CFGFILE_BASENAME"


usage="Usage: $progname [OPTION...]
Generate $CFGFILE from the files in $CNFDIR.

Options:
      --quiet            don't write anything to the standard output during
                         normal operation
      --help             display this help message and exit
      --version          output version information and exit"


DebPkgProvidedMaps_magic_comment="^# -_- DebPkgProvidedMaps -_-"


include_file()
{
    echo "### From file: $file" >>"$tempfile"
    cat "$file" >>"$tempfile"
    echo "### End of file: $file" >>"$tempfile"
}

do_not_include_file()
{
    printf "\
#
### $file not included because the
### corresponding package seems to be removed.
#\n" >>"$tempfile"
}


# -v (verbose) is here for backward compatibility only.
TEMP=$(getopt -o +v --longoptions quiet,help,version -n "$progname" -- "$@")

case $? in
    0) : ;;
    1) echo "$usage" >&2; exit 1 ;;
    *) exit 1 ;;
esac

# Don't remove the quotes around $TEMP!
eval set -- "$TEMP"

# Defaults
quiet=1

while true; do
    case "$1" in
        --quiet) quiet=1; shift ;;
        -v) printf "\
${progname}'s -v option is deprecated. The default mode of operation will
be verbose as soon as enough packages use the --quiet option. Please update
your scripts accordingly.\n\n" >&2; quiet=0; shift ;;
        --help) echo "$usage"; exit 0 ;;
        --version) echo "$progname $version"; exit 0 ;;
        --) shift; break ;;
         *) echo "$progname: unexpected option '$1'; please report a bug." >&2
            exit 1 ;;
    esac
done

# Non-option arguments are not allowed.
if [ $# -ne 0 ]; then
    echo "$usage" >&2
    exit 1
fi

if [ -L "$CFGFILE" ]; then
    if [ $quiet = 0 ]; then
        echo "$CFGFILE is a symbolic link; $progname won't do anything."
    fi
    exit 0
fi

if ! [ -r "$CNFDIR/00updmap.cfg" ] ; then
    echo "$progname: cannot read $CNFDIR/00updmap.cfg" >&2
    exit 1
fi

if [ $quiet = 0 ]; then
  if [ -f "${VARD}/updmap.cfg" ]; then
    echo -n "Regenerating ${VARD}/updmap.cfg... "
  else
    echo -n "Generating ${VARD}/updmap.cfg... "
  fi
fi

tempfile=$(mktemp -t "${progname}.XXXXXX") || exit 1
# This should not be racy, because the file should be created by mktemp with
# root as the owner (if we are running as root) and 600 as the mode. Depending
# on local configuration, the owner group might be something else than root,
# so we call chown to be sure, and then set the appropriate mode, i.e. 644.
chown root:root "$tempfile"
chmod 644 "$tempfile"

printf "\
### This file was automatically generated by ${progname}.
#
# Please do not edit it directly. If you want to add or change
# anything, please have a look at the files in ${CNFDIR}/ and
# invoke ${progname}.
#
###\n\n" >"$tempfile"

find "$CNFDIR" -type f -name '*.cfg' | LC_COLLATE=C sort | while read file; do
    # Does "$file" have the magic comment?
    if grep -E "$DebPkgProvidedMaps_magic_comment" "$file" >/dev/null; then
        # Is the package "$file" comes from still installed?
        if [ -d "$FONTMAP_MEMORY_DIR" ] \
            && find "$FONTMAP_MEMORY_DIR" -name '*.list' -print0 \
               | xargs -0r cat \
               | grep -E "^$(basename "$file" .cfg)\$" >/dev/null; then
            include_file "$file"
        else
            do_not_include_file "$file"
        fi
    else
        include_file "$file"
    fi
done

mv "$tempfile" "$CFGFILE"

if [ $quiet = 0 ]; then
    printf "done.\n\n"
    echo "$progname has updated ${CFGFILE_BASENAME}. If you want to generate"
    echo "the map files with the new ${CFGFILE_BASENAME}, you should call" \
         "updmap."
fi

